# tutorial

## 注意

建议在 typora 下阅读

## 密码结构

将 16 位数据块分解为 4 个 4-bit 子块。每个子块形成一个 $4 \times 4$ $S$ 盒的输入（用 4 输入位和 4 输出位替换），由 4 个输入位表示的整数进行索引。S 盒最基本的性质是它是一个非线性映射，即输出位不能表示为对输入位的线性操作。

在该密码体系下，所有的 S 盒都是相同的（从 DES 的第一个 S 盒的第一行取得的），S 盒的结构和代换规则分别如下图1所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/CtPh6Dp9R8B1UTa.png" alt="差分分析-pic5.png" style="zoom: 50%;" />

<center><text><b>图1</b></text></center>

非线性替换 $S$ 盒如下表1所示：

<center><text><b>表1</b></text></center>

![差分分析-pic2.png](https://cdn.jsdelivr.net/gh/Lyhappig/images/PzMDmLGRVFIawEk.png)

 $P$ 置换如下表2所示，最后一轮没有置换：

<center><text><b>表2</b></text></center>

![差分分析-pic3.png](https://cdn.jsdelivr.net/gh/Lyhappig/images/7stacLrwP5CRdzQ.png)

密码体系结构如下图2所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/TsVGH1P7JkOyRCe.png" alt="差分分析-pic4.png" style="zoom: 50%;" />

<center><text><b>图2</b></text></center>

## 线性分析

### 攻击概述

线性密码分析试图利用涉及明文比特、密文比特、部分子密钥比特的线性表达式的高概率出现的优点。这是一种已知的明文攻击，已知明文攻击的前提是攻击者拥有多组明文和对应的密文有关的信息，但是攻击者不知道哪些明密文是可用的。在许多场景中，可以合理地假设攻击者拥有一组随机的明密文对。

其基本思想是用一个线性表达式来近似部分密码的操作，表达形式是：
$$
X_{i_1} \oplus X_{i_2} \oplus \cdots \oplus X_{i_u} \oplus Y_{j_1} \oplus Y_{j_2} \oplus \cdots \oplus Y_{j_v} = 0 \tag{1}
$$
其中 $X_i$ 代表输入 $X=[X_1,X_2,\ldots]$ 的第 $i$ 个比特，$Y_j$ 代表输出 $Y=[Y_1,Y_2,\ldots]$ 的第 $j$ 个比特，然后对这些比特求一个异或和。

如果一个分组密码显示出 (1) 式的高概率存在或高概率不存在的趋势，说明该密码随机化能力较差。线性密码分析正是根据这一特点进行攻击。

如果我们随机选择 $u+v$ 个比特，并将它们放入 (1) 的方程中，表达式成立的概率恰好是 $1/2$，在线性分析中，我们将一个线性表达式保持的概率偏离 $1/2$ 的量称为线性概率偏差 $\varepsilon$。若 (1) 式成立的概率为 $p$，那么 $\varepsilon=p - \frac{1}{2}$，线性概率偏差的绝对值越大，攻击时选择明文的数量就越少。

方程 (1) 可以被等价的表述，即右边是被攻击的轮密钥部分比特的异或和。如果所涉及的轮密钥部分比特的和为 0，则 (1) 的偏差将与涉及轮密钥部分比特和的表达式的偏差具有相同的符号（正或负），如果所涉及的轮密钥部分比特的和为 1，(1) 的偏差将会有与之相反的符号。

如何构造高度线性的表达式？通过考虑密码唯一非线性实现的 $S$ 盒。根据 $S$ 盒的非线性性质，可以在 $S$ 盒中的输入比特集和输出比特集之间建立线性近似。此外，将 $S$ 盒的线性近似连接在一起，这样中间位（即来自密码内部的数据位）被抵消，剩下了一种偏差较大且只涉及明文和最后一轮输入的线性表达式。

### 堆积引理

考虑两个随机的二进制变量 $X_1$ 和 $X_2$，首先注意到这些简单的关系：

- $X_1 \oplus X_2 = 0$ 是一个线性表达式，等价于 $X_1 = X_2$
- $X_1 \oplus X_2=1$ 是一个仿射表达式，等价于 $X_1 \neq X2$

假设给出了如下概率分布：
$$
\Pr(X_1 = i) = \left\{\begin{array}{@{}l@{\quad}l@{\quad}l@{}} p_1 & ,i = 0\\        1-p_1 & ,i=1     \end{array}\right.
$$
并且
$$
\Pr(X_2 = i) = \left\{\begin{array}{@{}l@{\quad}l@{\quad}l@{}} p_2 & ,i = 0 \\ 1-p_2 & ,i=1     \end{array}\right.
$$
如果两个随机变量是独立的，那么
$$
\Pr(X_1 = i, X_2 = j) = \left\{\begin{array}{@{}l@{\quad}l@{\quad}l@{}} 
p_1p_2 & ,i = 0,j=0 \\        
p_1(1-p_2) & ,i=0,j=1  \\   
(1-p_1)p_2 & ,i=1,j=0 \\
(1-p_1)(1-p_2) & ,i=1,j=1
\end{array}\right.
$$
那么 $X_1 \oplus X_2 = 0$ 的概率为
$$
\begin{aligned}
\Pr(X_1 \oplus X_2 = 0)
&= \Pr(X_1 = X_2) \\ 
&= \Pr(X_1 = 0, X_2 = 0) + \Pr(X_1 = 1, X_2 = 1) \\ 
&= p_1p_2 + (1-p_1)(1-p_2)
\end{aligned}
$$
和线性偏差概率 $\varepsilon=p - \frac{1}{2}$ 联系起来，令 $p_1 = \frac{1}{2} + \varepsilon_1,p_2 = \frac{1}{2} + \varepsilon_2$ ，其中 $\varepsilon_1,\varepsilon_2$ 是概率偏差且 $-\frac{1}{2} \leq \varepsilon_1, \varepsilon_2 \leq \frac{1}{2}$，因此：
$$
\begin{aligned}
\Pr(X_1 \oplus X_2 = 0)
&= (\frac{1}{2} + \varepsilon_1)(\frac{1}{2} + \varepsilon_2) + (\frac{1}{2} - \varepsilon_1)(\frac{1}{2} - \varepsilon_2) \\ 
&= \frac{1}{2} + 2 \cdot \varepsilon_1 \cdot \varepsilon_2
\end{aligned}
$$
因此 $X_1 \oplus X_2 = 0$ 的偏差 $\varepsilon_{1,2}$ 是
$$
\varepsilon_{1,2} = 2 \cdot \varepsilon_{1} \cdot \varepsilon_{2}
$$
上式可以扩展到 $n$ 个变量 $X_1,X_2,\ldots,X_n$，概率 $\Pr(X_i = 0) = 1/2 + \varepsilon_i$。假设所有的 $n$ 个随机变量都是独立的，那么 $\Pr(X_1 \oplus X_2 \oplus \cdots \oplus X_n)$ 的概率可以通过堆积引理来计算。

#### 堆积引理

对于 $n$ 个独立随机变量 $X_1,X_2,\ldots,X_n$
$$
\Pr(X_1 \oplus X_2 \oplus \cdots \oplus X_n) = \frac{1}{2} + 2^{n-1} \prod_{i=1}^n \varepsilon_i
$$
令 $\varepsilon_{1,2,\ldots,n}$ 为 $X_1 \oplus X_2 \oplus \cdots \oplus X_n$ 的偏差，即
$$
\varepsilon_{1,2,\ldots,n} = 2^{n-1} \prod_{i=1}^n \varepsilon_i
$$
注意到如果 $\forall i, p_i = 0/1$，那么 $\Pr(X_1 \oplus X_2 \oplus \cdots \oplus X_n) = 0/1$；如果 $\exist i, p_i = 1/2$，那么 $\Pr(X_1 \oplus X_2 \oplus \cdots \oplus X_n) = 1/2$

#### 证明

堆积引理的证明可以采用数学归纳法。

#### 扩展

在寻找密码的线性近似时，$X_i$ 实际上将代表 $S$ 盒的线性近似。例如，考虑 4 个独立随机的二进制变量 $X_1,X_2,X_3,X_4$。令 $\Pr(X_1 \oplus X_2 = 0)= 1/2 + \varepsilon_{1,2}$ 和 $\Pr(X_2 \oplus X_3 = 0)= 1/2 + \varepsilon_{2,3}$，并考虑 $X_1 \oplus X_3 = (X_1 \oplus X_2) \oplus (X_2 \oplus X_3)$。因此：
$$
\Pr(X_1 \oplus X_3 = 0) = \Pr((X_1 \oplus X_2) \oplus (X_2 \oplus X_3) = 0)
$$
这说明可以结合两个线性表达式形成一个新的线性表达式。因为随机变量 $X_1 \oplus X_2$ 和 $X_2 \oplus X_3$ 可以认为是独立的，所以可以使用堆积引理来确定
$$
\Pr(X_1 \oplus X_3 = 0)=\frac{1}{2} + 2 \cdot \varepsilon_{1,2} \cdot \varepsilon_{2,3}
\\
\varepsilon_{1,3}  = 2 \cdot \varepsilon_{1,2} \cdot \varepsilon_{2,3}
$$
如上所述，表达式 $X_1 \oplus X_2 = 0$ 和 $X_2 \oplus X_3 = 0$ 类似于 $S$ 盒的线性近似，而 $X_1 \oplus X_3 = 0$ 类似于加密过程，其中中间变量 $X_2$ 被消除。当然，真实的分析涉及到许多 $S$ 盒的线性近似，将更加复杂。

### S盒线性逼近

考虑图1的 S-box 表示，其中包含输入 $X=(X_1,X_2,X_3,X_4)$ 和相应的输出 $Y=(Y_1,Y_2,Y_3,Y_4)$。通过研究方程 (1) 形式的所有表达式，所有的线性近似都可以通过计算它们的概率偏差。

例如，对于在密码中使用的 S-box，考虑线性表达式 $X_2 \oplus X_3 \oplus Y_1 \oplus Y_3 \oplus Y_4 = 0$ 或等价的写法 $X_2 \oplus X_3 = Y_1 \oplus Y_3 \oplus Y_4$

枚举 $X$ 的所有 16 个可能的输入值并检查相应的输出值 $Y$，可以观察到，16 种情况中的 12 种可以使得表达式成立。因此概率偏差为 $12/16−1/2=1/4$，如表 3 所示。

类似的，对于方程 $X_1 \oplus X_4 = Y_2$ 可以查表得到其偏差概率为 0；对于方程 $X_3 \oplus X_4 = Y_1 \oplus Y_4$，概率偏差为 $2/16-1/2=-3/8$。在最后一种情况下，最佳近似是由负号表示的仿射近似。然而攻击成功的概率是基于偏差的大小，因此仿射近似可以等价地用于线性近似。

<center><text><b>表3</b></text></center>

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images//%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AF%86%E7%A0%81%E5%AD%A6-%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90-%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-%E7%AE%80%E5%8D%95SPN%E5%AF%86%E7%A0%81%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-pic1.png" style="zoom:50%;" />

<center><text><b>表4</b></text></center>

![](https://cdn.jsdelivr.net/gh/Lyhappig/images//%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AF%86%E7%A0%81%E5%AD%A6-%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90-%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-%E7%AE%80%E5%8D%95SPN%E5%AF%86%E7%A0%81%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-pic2.png)

在表 4 的线性近似表中给出了我们的密码中 S-box 的所有线性近似的枚举。其中行和列的对应的二进制编号实际上是输入和输出的掩码：设 $X \in \{0, 1\}^n$，$X$ 的线性掩码定义为某个向量 $\Gamma X \in \{0,1\}^n$，$\Gamma X$ 和 $X$ 的内积 $\Gamma X \cdot X$ 代表 $X$ 某些分量的线性组合，即 $\Gamma X \cdot X = \bigoplus_\limits{i=1}^n \Gamma X_i \cdot X_i$

表 4 中的每个元素表示以十六进制表示的 "输入和" 表示的线性异或方程与以十六进制表示的 "$S$ 盒输出和" 表示的输出异或和之间的匹配数减去 8。因此，将表 4 中一个元素值除以 16 给出了输入和输出位的特定线性组合的概率偏差。例如，线性方程 $X_3 \oplus X_4 = Y_1 \oplus Y_4$（十六进制输入 3 和十六进制输出 9）的概率偏差为 $−6/16=−3/8$，线性方程成立的概率为 $1/2−3/8 = 1/8$

可以注意到线性近似表的一些基本性质。例如除了表中首个元素外第一行和第一列的所有元素，方程 (1) 成立的概率均恰好为 $1/2$，原因是 $S$ 盒是双射的。还可以注意到，任何行或任何列的和都必须是 $+8$ 或 $−8$。证明也是从 $S$ 盒双射的性质入手。 

### 构造线性逼近

一旦得到了 $S$ 盒的线性近似表，通过连接适当的 $S$ 盒的线性近似，就可以确定方程 (1) 形式的整体密码的线性近似。通过构造一个涉及明文比特和倒数第二轮 $S$ 盒输出比特的线性近似，可以通过恢复最后一轮轮密钥的一个子集来攻击密码，用一个例子来说明。

考虑一个包含 $S_{12},S_{22},S_{32},S_{34}$ 的线性近似，如图3所示。使用以下 S-box 的近似值：

- $S_{1,2}:\quad X_1 \oplus X_3 \oplus X_4 = Y_2$，线性概率 $12/16$，线性偏差 $+1/4$
- $S_{2,2}:\quad X_2 = Y_2 \oplus Y_4$，线性概率 $4/16$，线性偏差 $-1/4$
- $S_{3,2}:\quad X_2 = Y_2 \oplus Y_4$，线性概率 $4/16$，线性偏差 $-1/4$
- $S_{3,4}:\quad X_2 = Y_2 \oplus Y_4$，线性概率 $4/16$，线性偏差 $-1/4$

令 $U_i(V_i)$ 表示第 $i$ 轮 $S$ 盒的输入（输出）的 16 比特块，$U_{i,j}(V_{i,j})$ 表示块 $U_i(V_i)$ 的第 $j$ 位（在图中从左到右为 1 到 16）。令 $K_i$ 表示第 $i$ 轮的轮密钥，$P$ 表示 16 比特的明文输入，$C$ 表示 16 比特的密文输出。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images//%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AF%86%E7%A0%81%E5%AD%A6-%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90-%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-%E7%AE%80%E5%8D%95SPN%E5%AF%86%E7%A0%81%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90-pic3.png" style="zoom:50%;" />

<center><text><b>图3</b></text></center>

使用第 1 轮线性逼近，构造概率为 $3/4$ 的方程：
$$
\begin{aligned}
V_{1,6}
&=U_{1,5} \oplus U_{1,7} \oplus U_{1,8} \\
&=(P_5 \oplus K_{1,5}) \oplus (P_7 \oplus K_{1,7}) \oplus (P_8 \oplus K_{1,8})
\end{aligned}
\tag{2}
$$
对于第 2 轮的线性逼近，构造概率为 $1/4$ 的方程：
$$
V_{2,6} \oplus V_{2,8} = U_{2,6}
$$
因为 $U_{2,6} = V_{1,6} \oplus K_{2,6}$，我们可以构造如下线性逼近的形式
$$
V_{2,6} \oplus V_{2,8} = V_{1,6} \oplus K_{2,6}
$$
再与方程 (2) 进行合并，可以得到：
$$
V_{2,6} \oplus V_{2,8} \oplus P_5 \oplus P_7 \oplus P_8 \oplus K_{1,5} \oplus K_{1,7} \oplus K_{1,8} \oplus K_{2,6} = 0
\tag{3}
$$
通过堆积引理可以得出概率为 $1/2 + 2(3/4 - 1/2)(1/4 - 1/2)=3/8$，线性偏差概率为 $-1/8$。注意，使用堆积引理的假设是 $S$ 盒的线性近似是独立的，虽然并不严格正确，但实践中对大多数密码都很有效。

对于第 3 轮，分别构造两个概率均为 $1/4$ 的方程：
$$
V_{3,6} \oplus V_{3,8} = U_{3,6} \\
V_{3, 14} \oplus V_{3, 16} = U_{3,14}
$$
由于 $U_{3,6}=V_{2,6} \oplus K_{3,6}$ 和 $U_{3,14}=V_{2,8} \oplus K_{3,14}$，得
$$
V_{3,6} \oplus V_{3,8} \oplus V_{3, 14} \oplus V_{3, 16} \oplus V_{2,6} \oplus K_{3,6} \oplus V_{2,8} \oplus K_{3,14} = 0
\tag{4}
$$
再一次利用堆积引理得出概率为 $1/2+2(1/4−1/2)^2=5/8$，偏差为 $+1/8$

现在结合 (3) 式和 (4) 式，即结合所有 4 个 S-box 的线性近似，我们得到
$$
V_{3,6} \oplus V_{3,8} \oplus V_{3, 14} \oplus V_{3, 16} \oplus P_5 \oplus P_7 \oplus P_8 \oplus K_{1,5} \oplus K_{1,7} \oplus K_{1,8} \oplus K_{2,6} \oplus K_{3,6} \oplus K_{3,14} = 0
$$ { }
注意到 $U_{4,6} = V_{3,6} \oplus K_{4,6},U_{4,8} = V_{3,14} \oplus K_{4,8}, U_{4,14} = V_{3, 8} \oplus K_{4,14},U_{4,16} = V_{3,16} \oplus K_{4,16}$，可以得到
$$
U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus P_5 \oplus P_7 \oplus P_8 \oplus \{K_i\} = 0 \\
\{K_i\} = K_{1,5} \oplus K_{1,7} \oplus K_{1,8} \oplus K_{2,6} \oplus K_{3,6} \oplus K_{3,14} \oplus K_{4, 6} \oplus K_{4, 8} \oplus K_{4, 14} \oplus K_{4, 16}
$$
$\{K_i\}$ 被固定于 0 或 1。通过应用堆积引理，上述表达式的概率为 $1/2+2^3 (3/4−1/2)(1/4−1/2)^3=15/32$，线性偏差为 $-1/32$

因为密钥比特是固定的，那么有
$$
U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus P_5 \oplus P_7 \oplus P_8  = 0
\tag{5}
$$
式 (5) 成立的概率是 $15/32$ 或 $17/32$，取决于 $\{K_i\} = 0/1$，一旦给定轮密钥， $\{K_i\}$ 就会被固定，那么：

- 若 $\{K_i\}=0$，$U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus P_5 \oplus P_7 \oplus P_8  = 0$ 为线性近似，概率偏差为 $-1/32$
- 若 $\{K_i\}=1$，$U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus P_5 \oplus P_7 \oplus P_8  = 1$ 为仿射近似，近似等价于线性近似，概率偏差为 $1/32$

我们现在有了一个前 3 轮密码的线性近似，其偏差绝对值为 $1/32$。接下来要利用偏差确定轮密钥的部分比特。

### 获取密钥比特

对于 $R$ 轮的密码，一旦发现了具有较大线性概率偏差的 $R−1$ 轮线性近似，就可以通过恢复第 $R$ 轮轮密钥来对密码进行攻击。

在上述示例中，得到了 $3$ 轮线性逼近，那么就可以提取 $K_5$ 的部分密钥比特。把要从最后一个子密钥中恢复的比特称为目标部分子密钥。具体来说，目标部分子密钥是最后一轮中与 $S$ 盒关联的子密钥的比特，即受到线性逼近影响的数据比特。

式 (5) 的线性表达式影响了最后一轮中 $S_{42}$ 和 $S_{44}$ 的输入。对于样本的每个明密文对，尝试枚举目标部分子密钥 $[K_{5,5},\ldots,K_{5,8},K_{5,13},\ldots,K_{5,16}]$ 的 256 个取值。对密文经过目标部分子密钥和 $S_{42},S_{44}$ 的逆运算，可以确定 $[U_{4,5}, \ldots,U_{4, 8},U_{4, 13}, \ldots, U_{4,16}]$ 的值，当表达式 (5) 为真时，增加对应目标部分子密钥计数器的值。偏离明文/密文样本数量的一半的最大计数被假设为正确的值。偏差的正负将取决于 $\{K_i\}$ 中涉及的子密钥比特的值。当 $\{K_i\}=0$ 时，式 (5) 的线性近似概率 $\Pr<1/2$，否则式 (5) 的概率 $\Pr>1/2$

通过生成 10000 个已知的明密文对，最后一轮目标子密钥值确定为 $[K_{5,5},\ldots, K_{5,8}] = [0010], [K_{5,13}, \ldots ,K_{5,16}]=[0100]$，遵循对目标部分子密钥所描述的密码分析过程。如预期的那样，与 5000 相差最大的计数对应于目标部分子键值 $[2,4]_x$，表明攻击成功。

最大计数值对应线性偏差概率 $|\varepsilon|=|\text{count} - 5000| / 10000$ 在 $0.03125$ 上下浮动。注意到也会有其他较大值会略微接近线性偏差概率 $|1/32|$ 一些，有其他大的偏差值出现，表明对不正确的目标部分子密钥的检查并不完全等同于比较随机数据与线性表达式（偏差为 0）。实验结果偏差的不一致可能有以下几个原因：

- $S$ 盒的特性影响了不同部分子密钥的部分解密
- 实验偏差的不精确性
- 在堆积引理中使用所需的独立性假设
- 线性壳的影响

### 攻击复杂度

假设被线性近似影响的 $S$ 盒称为活跃 $S$ 盒，一个线性表达式成立的概率与活跃 $S$ 盒的线性偏差和活跃 $S$ 盒的数量有关。一般来说，$S$ 盒的偏差幅度越大，线性表达式的偏差幅度越大；活跃的 $S$ 盒越少，线性表达式偏差的幅度就越大。

设 $\varepsilon$ 表示完整密码的线性表达式成立的概率相比 $1/2$ 的偏差，即 $\varepsilon = \Pr - 1/2$。Matsui 表明攻击所需的已知明文数量与 $\varepsilon^{−2}$ 成正比，令 $N_L$ 表示所需的明文数量，$c$ 是一个小倍数，则：
$$
N_L \approx c \cdot \frac{1}{\varepsilon^2}
$$

### 攻击结论

由于偏差是使用堆积引理推导出来的，其中乘积的每一项都是一个 $S$ 盒的线性近似，所以容易得出偏差依赖于 $S$ 盒线性近似的偏差和活跃 $S$ 盒的数量。针对线性密码分析安全性的一般方法主要集中在优化 $S$ 盒，即最小化最大的偏差，并找到结构来最大化活跃 $S$ 盒的数量。

线性密码分析的安全性证明通常是以不存在高概率的线性逼近为前提。然而，这种线性近似的概率计算是基于每个 $S$ 盒的线性近似都是独立的假设（因此才可以使用堆积引理）以及基于一个线性近似场景。现实是 $S$ 盒的线性近似不是独立的，这可能对概率的计算产生重大影响。此外，具有相同的线性表达式，但具有不同活跃 $S$ 盒集合的线性逼近可以组合起来，得到一个更高的线性概率，这个概念被称为**线性壳**。最值得注意的是，一些线性近似场景可能有非常小的偏差，然而当这些场景组合时，可能会产生具有非常高偏差的线性壳。
